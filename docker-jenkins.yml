---
- hosts: localhost
  become: True
  connection: local
  vars_files:
   - jobs.yml
  tasks:
      - package: name={{item}}
        with_items:
          - python3
          - jq
          - python3-pip
          - java-1.8.0-openjdk
          - gcc
      - pip: name={{item}} state=latest executable=/usr/bin/pip3
        with_items:
          - yamllint
          - jenkins-job-builder
          - docker-compose
          # - docker-py
      # - pip: name={{item}} state=latest executable=/usr/bin/pip2.7
      #   with_items:
      #     - six==1.10.0
      - file:
          path: /etc/jenkins_jobs/{{ item }}
          state: directory
        with_items:
          - jobs
          - config
      - file:
          path: /opt/jenkins/
          state: directory
          owner: ec2-user
          group: ec2-user
      - copy:
          src: ./files/{{ item }}
          dest: /opt/jenkins/{{ item }}
          owner: ec2-user
          group: ec2-user
        with_items:
          - add_admin.groovy
          - Dockerfile
          - docker-compose.yml
      - template: src="./templates/jenkins_jobs.ini.tmp" dest="/etc/jenkins_jobs/jenkins_jobs.ini" mode=0600 owner="ec2-user"
        with_items: "{{ jobs }}"
      - template: src="./templates/jenkins_job.tmp" dest="/etc/jenkins_jobs/jobs/{{item.name}}.yml" mode=0600 owner="ec2-user"
        with_items: "{{ jobs }}"
      # - docker_image:
      #      path: /opt/jenkins
      #      name: bhjenkins
      # - docker_service:
      #     project_src: /opt/jenkins
      #     build: yes
      #   register: output
      # - wait_for:
      #     host: 0.0.0.0
      #     port: 8080
      #     delay: 10
      - docker_compose:
        project_name: bhjenkins
        definition:
            jenkins:
              image: bhjenkins:latest
              container_name: jenkins
              user: jenkins
              volumes:
                - /opt/jenkins/:/var/jenkins_home
                - /opt/jenkins/var/run/docker.sock:/var/run/docker.sock
                - /etc/jenkins_jobs/:/etc/jenkins_jobs
              environment:
                JAVA_OPTS: "-Dhudson.Main.development=true -Djenkins.install.runSetupWizard=false"
              ports:
                - "8080:8080"
                - "5000:5000"
                - "50000:50000"

      # - command: /usr/local/bin/jenkins-jobs update {{item}}
      #   with_fileglob:
      #     - /etc/jenkins_jobs/jobs/*.yml
      #   register: output
      # - debug: var=output
